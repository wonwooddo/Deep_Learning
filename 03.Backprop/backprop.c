/*********************************************************/
/*                      bp1.c                            */
/* ?????????????? ????? ???? ?н?                   */
/* ?????? ????? ?н?????? ??? ???? ??? ???? ???     */
/*********************************************************/

/*Visual Studio???? ???? ??? */
#define _CRT_SECURE_NO_WARNINGS

/* ??? ???? ????*/
#include <stdio.h>
#include <stdlib.h>
#include <math.h>

/*??? ??? ????*/
#define INPUTNO 3  /*????? ?? ????*/ 
#define HIDDENNO 3  /*????? ?? ????*/ 
//#define INPUTNO 10  /*????? ?? ????*/ 
//#define HIDDENNO 3  /*????? ?? ????*/ 

#define ALPHA  10  /*?н? ???*/ 
#define SEED 65535    /*???? ???*/ 
#define MAXINPUTNO 100    /*?н? ???????? ??? ????*/ 
#define BIGNUM 100    /*?????? ??갪*/ 
#define LIMIT 0.001    /*?????? ??갪*/ 

/*??? ????????? ????*/
double f(double u); /*??? ???(??????? ???)*/
void initwh(double wh[HIDDENNO][INPUTNO + 1]);
/*????? ???????????*/
void initwo(double wo[HIDDENNO + 1]);/*????? ??????? ????*/
double drnd(void);/* ???? ????     */
void print(double wh[HIDDENNO][INPUTNO + 1], double wo[HIDDENNO + 1]); /*??? ???*/
double forward(double wh[HIDDENNO][INPUTNO + 1], double wo[HIDDENNO + 1], double hi[], double e[INPUTNO + 1]); /*?????? ???*/
void olearn(double wo[HIDDENNO + 1], double hi[], double e[INPUTNO + 1], double o); /*????? ??????? ????*/
int getdata(double e[][INPUTNO + 1]); /*?н? ?????? ?о?????*/
void hlearn(double wh[HIDDENNO][INPUTNO + 1], double wo[HIDDENNO + 1], double hi[], double e[INPUTNO + 1], double o); /*????? ??????? ????*/

/*******************/
/*    main() ???  */
/*******************/
int main()
{
	double wh[HIDDENNO][INPUTNO + 1];/*????? ?????*/
	double wo[HIDDENNO + 1];/*????? ?????*/
	double e[MAXINPUTNO][INPUTNO + 1];/*?н? ?????? ???*/
	double hi[HIDDENNO + 1];/*????? ???*/
	double o;/*???*/
	double err = BIGNUM;/*???? ??*/
	int i, j;/*??? ????*/
	int n_of_e;/*?н? ?????? ????*/
	int count = 0;/*??? ??? ?????*/
	FILE * fw = fopen("train_error.txt","w");
	
	/*???? ????*/
	srand(SEED);

	/*????? ????*/
	initwh(wh);/*????? ??????? ????*/
	initwo(wo);/*????? ??????? ????*/
	print(wh, wo); /*??? ???*/

	/*?н? ?????? ?о?????*/
	n_of_e = getdata(e);
	printf("?н? ?????? ????:%d\n\n", n_of_e);
	printf("Epoch\tError\n");
	/*?н?*/
	while (err > LIMIT) {
		err = 0.0;
		for (j = 0; j < n_of_e; ++j) {
			/*?????? ???*/
			o = forward(wh, wo, hi, e[j]);
			/*????? ??????? ????*/
			olearn(wo, hi, e[j], o);
			/*????? ??????? ????*/
			hlearn(wh, wo, hi, e[j], o);
			/*???? ???*/
			err += (o - e[j][INPUTNO])*(o - e[j][INPUTNO]);
		}
		++count;
		/*???? ???*/
		fprintf(fw, "%d\t%lf\n", count, err);
		printf("%d\t%lf\n", count, err);

	}/*?н? ????*/

	/*???? ???? ???*/
	printf("\n\n");
	print(wh, wo);

	/*?н? ??????? ???? ???*/
	for (i = 0; i < n_of_e; ++i) {
		printf("[Test_set %d]  Inputs = ", i);
		for (j = 0; j < INPUTNO ; ++j)
			printf("%.0lf ", e[i][j]);

		o = forward(wh, wo, hi, e[i]);
		printf("output = %lf\n", o);
		printf("target = %.0lf\n", e[i][j]);
	}

	fclose(fw);
	return 0;
}

/**************************/
/*  hlearn() ???         */
/*  ????? ??????? ?н?  */
/**************************/
void hlearn(double wh[HIDDENNO][INPUTNO + 1],double wo[HIDDENNO + 1],double hi[], double e[INPUTNO + 1], double o)
{
	int i, j;/*??? ????*/
	double dj;/*????? ????? ??꿡 ???*/

	for (j = 0; j < HIDDENNO; ++j) {/*????? ?? ?? j?? ???????*/
		dj = (o - e[INPUTNO])*o*(1 - o) * hi[j] * (1 - hi[j])*wo[j] ;
		for (i = 0; i < INPUTNO; ++i)/*i??° ????? ???*/
			wh[j][i] -= ALPHA*e[i] * dj;
		wh[j][i] -= ALPHA*(-1.0)*dj;/*??? ?н?*/
	}
}

/*************************/
/*  getdata() ???       */
/* ?н? ?????? ?о?????*/
/*************************/
int getdata(double e[][INPUTNO + 1])
{
	FILE* fp = fopen("data/data2.txt", "r");
	if (fp == NULL)
	{
		printf("file open error!\n");
		exit(1);
	}
	int n_of_e = 0;/*?????? ??? ????*/
	int j = 0;/*??? ?????*/

	/*?????? ???*/
	while (fscanf(fp,"%lf", &e[n_of_e][j]) != EOF) {
		++j;
		if (j > INPUTNO) {/*???? ?ε?????*/
			j = 0;
			++n_of_e;
		}
	}
	fclose(fp);
	return n_of_e;
}

/*************************/
/* olearn() ???         */
/* ??????? ????? ?н?  */
/*************************/
void olearn(double wo[HIDDENNO + 1], double hi[], double e[INPUTNO + 1], double o)
{
	int i;/*??? ????*/
	double d;/*????? ??꿡 ???*/

	d = (o - e[INPUTNO])*o*(1 - o);/*???? ???*/
	for (i = 0; i < HIDDENNO; ++i) {
		wo[i] -= ALPHA*hi[i] * d;/*????? ?н?*/
	}
	wo[i] -= ALPHA*(-1.0)*d;/*??? ?н?*/
}

/**********************/
/*  forward() ???    */
/*  ?????? ???       */
/**********************/
double forward(double wh[HIDDENNO][INPUTNO + 1],
	double wo[HIDDENNO + 1], double hi[],
	double e[INPUTNO + 1])
{
	int i, j;/*??? ????*/
	double u;/*??????? ?????? ?? ???*/
	double o;/*??? ???*/

	/*hi ???*/
	for (i = 0; i < HIDDENNO; ++i) {
		u = 0;/*??????? ?????? ?? ?????*/
		for (j = 0; j < INPUTNO; ++j)
			u += e[j] * wh[i][j];
		u -= wh[i][j];/*??? ???*/
		hi[i] = f(u);
	}
	/*??? o ???*/
	o = 0;
	for (i = 0; i < HIDDENNO; ++i)
		o += hi[i] * wo[i];
	o -= wo[i];/*??? ???*/

	return f(o);
}

/**********************/
/*   print() ???     */
/*   ??? ???        */
/**********************/
void print(double wh[HIDDENNO][INPUTNO + 1], double wo[HIDDENNO + 1])
{
	int i, j;/*??? ????*/
	printf("[hidden weights]\n");
	for (i = 0; i < HIDDENNO; ++i)
	{
		printf("hiden node %d\n", i);
		for (j = 0; j < INPUTNO + 1; ++j)
			printf("weight %d : %.2lf \n", j, wh[i][j]);
	}
	printf("\n");
	printf("[output weights]\n");
	for (i = 0; i < HIDDENNO + 1; ++i)
		printf("weight %d : %.2lf\n",i, wo[i]);
	printf("\n");
}

/************************/
/*    initwh() ???     */
/*????? ??????? ????*/
/************************/
void initwh(double wh[HIDDENNO][INPUTNO + 1])
{
	int i, j;/*??? ????*/

	/*?????? ????? ????? ????*/
	for (i = 0; i < HIDDENNO; ++i)
		for (j = 0; j < INPUTNO + 1; ++j)
			wh[i][j] = drnd();
}

/************************/
/*    initwo() ???     */
/*????? ??????? ????*/
/************************/
void initwo(double wo[HIDDENNO + 1])
{
	int i;/*??? ????*/

	/*?????? ????? ????? ????*/
	for (i = 0; i < HIDDENNO + 1; ++i)
		wo[i] = drnd();
}

/*******************/
/* drnd() ???     */
/* ???? ????       */
/*******************/
double drnd(void)
{
	double rndno;/*?????? ????*/

	while ((rndno = (double)rand() / RAND_MAX) == 1.0);
	rndno = rndno * 2 - 1;/*-1???? 1 ?????? ???? ????*/
	return rndno;
}

/*******************/
/* f() ???        */
/* ??? ???       */
/*(??????? ???)*/
/*******************/
double f(double u)
{
	return 1.0 / (1.0 + exp(-u));
}
